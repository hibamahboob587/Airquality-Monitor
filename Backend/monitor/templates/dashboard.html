{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Air Quality Dashboard</title>
  <meta http-equiv="refresh" content="5">


  <!-- External Styles -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'JetBrains Mono', monospace;
      background-image: url("{% static 'clouds2.jpg' %}");
      background-size: 200% 200%;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      animation: animateBg 15s ease infinite, fadeIn 1s ease-out forwards;
    }

    @keyframes animateBg {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: 1rem;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      transition: transform 0.3s ease;
    }

    .glass-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.2);
    }

    .main-text {
      color: #3D90D7;
    }

    .secondary-text {
      color: #EAEAEA;
    }

    .hidden {
      display: none;
    }

    .arrow {
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .arrow.open {
      transform: rotate(180deg);
    }
    .btn {
      background-color: #3D90D7;
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 1rem;
      transition: background-color 0.3s ease;
      text-align: center;
      cursor: pointer;
      display: inline-block;
      margin-top: 20px;
    }
    .btn:hover {
      background-color: #2c74b3;
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center p-5">
  <div class="max-w-7xl w-full">

    <!-- Cards and Chart Section -->
    <div class="flex flex-wrap md:flex-nowrap justify-center gap-6">

      <!-- Combined Temp & Humidity Card -->
      <div class="glass-card p-6 flex flex-col justify-start items-start w-full md:w-1/3">
        
        <!-- Temperature Section -->
        <div class="flex items-center gap-3 mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="#94a3b8" viewBox="0 0 16 16">
            <path d="M9.5 12.5a1.5 1.5 0 1 1-2-1.415V6.5a.5.5 0 0 1 1 0v4.585a1.5 1.5 0 0 1 1 1.415"/>
            <path d="M5.5 2.5a2.5 2.5 0 0 1 5 0v7.55a3.5 3.5 0 1 1-5 0zM8 1a1.5 1.5 0 0 0-1.5 1.5v7.987l-.167.15a2.5 2.5 0 1 0 3.333 0l-.166-.15V2.5A1.5 1.5 0 0 0 8 1"/>
          </svg>
          <div>
            <h1 class="main-text text-7xl font-bold">{{ current_data.temperature }}&deg;C</h1>
            <p class="secondary-text text-xs mt-1 mb-5">{{ current_data.timestamp|date:"F j Y, g:i a" }}</p>
          </div>
        </div>

        <!-- Humidity Section -->
        <div class="flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="#94a3b8" viewBox="0 0 16 16">
            <path d="M8 16a6 6 0 0 0 6-6c0-1.655-1.122-2.904-2.432-4.362C10.254 4.176 8.75 2.503 8 0c0 0-6 5.686-6 10a6 6 0 0 0 6 6M6.646 4.646l.708.708c-.29.29-1.128 1.311-1.907 2.87l-.894-.448c.82-1.641 1.717-2.753 2.093-3.13"/>
          </svg>
          <div>
            <h2 class="main-text text-2xl font-semibold"> {{ current_data.humidity }}%</h2>
            <p class="secondary-text text-xl mt-1">Humidity</p>
          </div>
        </div>
        <div class="flex items-center gap-3 mt-3">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="#94a3b8" class="bi bi-balloon" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 9.984C10.403 9.506 12 7.48 12 5a4 4 0 0 0-8 0c0 2.48 1.597 4.506 4 4.984M13 5c0 2.837-1.789 5.227-4.52 5.901l.244.487a.25.25 0 1 1-.448.224l-.008-.017c.008.11.02.202.037.29.054.27.161.488.419 1.003.288.578.235 1.15.076 1.629-.157.469-.422.867-.588 1.115l-.004.007a.25.25 0 1 1-.416-.278c.168-.252.4-.6.533-1.003.133-.396.163-.824-.049-1.246l-.013-.028c-.24-.48-.38-.758-.448-1.102a3 3 0 0 1-.052-.45l-.04.08a.25.25 0 1 1-.447-.224l.244-.487C4.789 10.227 3 7.837 3 5a5 5 0 0 1 10 0m-6.938-.495a2 2 0 0 1 1.443-1.443C7.773 2.994 8 2.776 8 2.5s-.226-.504-.498-.459a3 3 0 0 0-2.46 2.461c-.046.272.182.498.458.498s.494-.227.562-.495"/>
          </svg>
          <div>
            <h2 class="main-text text-2xl font-semibold"> {{ current_data.airQuality }} ppm</h2>
            <p class="secondary-text text-xl mt-1">Air Quality</p>
          </div>
        </div>

        <!-- Description Section inside the Card -->
        <div class="mt-6">
          <h3 class="main-text text-xl font-semibold"></h3>
          <div id="descriptionMessage" class="mt-4 text-gray-300 hidden">
            <!-- Description will appear here -->
          </div>
          <div id="arrow" class="arrow mt-4">
            <i class="fas fa-chevron-down text-gray-200">   Description </i>
          </div>
        </div>
      </div>

      <!-- Doughnut Chart Card -->
      <div class="glass-card w-full md:w-1/3">
        <div class="flex flex-col items-center w-full h-full justify-center">
          <canvas id="combinedChart" class="w-32 h-32" style="max-width: 300px; max-height: 300px;"></canvas>
        </div>
      </div>

    </div>
    <div class="text-center mt-6">
      <a href="{% url 'upload_firmware' %}" class="btn">Upload file</a>
    </div>

  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    let combinedChart;

    async function fetchDataAndRenderCharts() {
      try {
        const response = await fetch('/api/get_all_data/');
        const data = await response.json();
        const latestData = data.slice(-50);

        const temperatureData = latestData.map(d => parseFloat(d.temperature));
        const humidityData = latestData.map(d => parseFloat(d.humidity));

        const avgTemp = (temperatureData.reduce((a, b) => a + b, 0) / temperatureData.length).toFixed(1);
        const avgHumidity = (humidityData.reduce((a, b) => a + b, 0) / humidityData.length).toFixed(1);

        const ctx = document.getElementById('combinedChart').getContext('2d');

        if (combinedChart) combinedChart.destroy();

        combinedChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Temperature', 'Humidity', 'Remaining'],
            datasets: [{
              data: [avgTemp, avgHumidity, 100 - avgTemp - avgHumidity],
              backgroundColor: ['#ff6384', '#36a2eb', '#e0e0e0'],
              borderWidth: 0
            }]
          },
          options: {
            cutout: '70%',
            plugins: {
              tooltip: { enabled: false },
              legend: { display: false },
              title: {
                display: true,
                text: 'Average Temperature & Humidity',
                color: '#EAEAEA'
              }
            }
          },
          plugins: [centerTextPlugin(`${avgTemp}Â°C / ${avgHumidity}%`)]
        });

        // Update description based on temperature and humidity
        updateDescription(avgTemp, avgHumidity, latestData[latestData.length - 1].airQuality);


      } catch (err) {
        console.error('Error fetching or rendering chart data:', err);
      }
    }

    function centerTextPlugin(text) {
      return {
        id: 'centerText',
        afterDraw(chart) {
          const { width, height, ctx } = chart;
          ctx.save();
          ctx.font = `bold ${height / 16}px 'JetBrains Mono', sans-serif`;  
          ctx.fillStyle = '#EAEAEA';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(text, width / 2, height / 2);
          ctx.restore();
        }
      };
    }

    function updateDescription(temperature, humidity, airQuality) {
      const descriptionElement = document.getElementById('descriptionMessage');
      let description = '';
    
      // Temperature-based messages
      if (temperature < 20) {
        description += 'It\'s a cool day. A light jacket might be a good idea.';
      } else if (temperature >= 20 && temperature < 30) {
        description += 'The weather is warm and pleasant.';
      } else {
        description += 'It\'s quite hot outside. Stay hydrated and avoid direct sunlight.';
      }
    
      description += '<br><br>';
    
      // Humidity-based messages
      if (humidity < 30) {
        description += 'The air is quite dry. Make sure to stay moisturized.';
      } else if (humidity >= 30 && humidity <= 60) {
        description += 'The humidity level is moderate, which is comfortable for most people.';
      } else {
        description += 'It\'s very humid. You might want to stay indoors or use air conditioning.';
      }
    
      description += '<br><br>';
    
      // Air Quality-based messages (based on CO2 PPM typical ranges)
      if (airQuality <= 400) {
        description += 'Excellent air quality. Fresh and clean!';
      } else if (airQuality <= 800) {
        description += 'Good air quality. Indoor environments are generally safe.';
      } else if (airQuality <= 1200) {
        description += 'Moderate air quality. It might start feeling stuffy.';
      } else if (airQuality <= 2000) {
        description += 'Poor air quality. Ventilation is recommended.';
      } else if (airQuality <= 5000) {
        description += 'Very poor air quality. Prolonged exposure can cause discomfort.';
      } else {
        description += 'Hazardous air quality detected! Immediate ventilation is necessary.';
      }
    
      descriptionElement.innerHTML = description;
    }
    
    

    document.getElementById('arrow').addEventListener('click', () => {
      const descriptionMessage = document.getElementById('descriptionMessage');
      const arrow = document.getElementById('arrow');

      descriptionMessage.classList.toggle('hidden');
      arrow.classList.toggle('open');

      // Toggle arrow direction
      const icon = arrow.querySelector('i');
      if (icon.classList.contains('fa-chevron-down')) {
        icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
      } else {
        icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
      }
    });

    fetchDataAndRenderCharts();
    setInterval(fetchDataAndRenderCharts, 10000);
  </script>

</body>
</html>
